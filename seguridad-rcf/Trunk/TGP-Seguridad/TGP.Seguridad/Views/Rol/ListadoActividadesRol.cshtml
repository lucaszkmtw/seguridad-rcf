@using TGP.Seguridad.BussinessLogic.Dto
@model IList<RolActividadViewModel>

    @{
        ViewBag.Title = "Seg - Listado de Actividades Por Rol";
        Layout = "~/Views/Shared/_LayoutBootstrap.cshtml";
    }

    <div class="uk-grid sigaf-titulo">
        <div class="uk-width-1-2">
            <h2 class="uk-margin-bottom">Listado de Actividades</h2>
        </div>
    </div>

    <div class="md-card">
        <div class="md-card-content">
            <div class="uk-grid uk-margin-top">
                <div class="uk-width-1-2">
                    <div class="md-input-wrapper md-input-filled">
                        @Html.Label("Aplicación", "Aplicación")
                        @Html.Partial("FiltroEstructuras", new Seguridad.FiltroEstructuras(false, null))
                    </div>
                </div>
                <div class="uk-width-1-2">
                    <div class="md-input-wrapper md-input-filled">
                        @Html.Label("Rol", "Rol")
                        @Html.DropDownList("roles", (SelectList)ViewBag.Roles, new { @class = "selectize md-input label-fixed" })
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="uk-grid" data-uk-grid-margin>
        <div class="uk-width-1-1">
            <div class="uk-form-row">
                <div class="md-card uk-margin-bottom">
                    <div class="md-card-content">
                        <div id="div-resultados">
                            @if (Model != null && Model.Count > 0)
                            {
                                @Html.Partial("Partials/_ResultadoActividadesRol")
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    @section scripts{
        <script src="~/ResourceDesign//Scripts/template/plugins/tippy/popper.js"></script>
        <script src="~/ResourceDesign//Scripts/template/plugins/tippy/tippy.js"></script>

        <script>
        $(document).ready(function () {
            activarMenu("#ActividadesPorRol-Rol");
            aplicarSelectize($('.selectize'));
            updateDatatable()
            $("#TableId input").on('keyup', function () {
                tableInstance.search(this.value).draw(); // try this easy code and check if works at first
            });
            $('#filterEstructuras').change();
        });

        $('#filterEstructuras').change(function () {
            if (!isNullOrEmpty('#filterEstructuras') && $("#filterEstructuras").val() != "") {
                //Menues asociados a la estructura
                $.ajax({
                   url: '@Url.Action("GetRolesChangeEstructura", "Rol")',
                   type: "POST",
                        data: {
                            cod: $('#filterEstructuras').val()
                        },
                    success: function (data) {
                       if (data !== null) {
                           let selectizeControl = $('#roles').selectize()[0].selectize;
                           selectizeControl.clearOptions();
                           $.each(data, function (i, data) {
                               if (data.Value === "0") {
                                   selectizeControl.addOption({ value: data.Value, text: data.Text });
                                   selectizeControl.addItem("0");
                               } else {
                                   selectizeControl.addOption({ value: data.Value, text: data.Text });
                               }
                           }
                           );
                           let array = Object.keys(selectizeControl.options);
                           if (array.length === 1) {
                               selectizeControl.addItem(array[0]);
                           }
                       }
                   },
                });

            }

        });



        $('#roles').change(function () {
            if (!isNullOrEmpty('#roles') && $("#roles").val() != ""){
                changeFilters();
            }
        });



        function changeFilters() {
        $.ajax(
            {
                url: '@Url.Action("ListadoActividadesPorRol", "Rol")',
                type: "POST",
                data: {
                    rol: $('#roles').val(),
                    est: $('#filterEstructuras').val()
                },
                beforeSend: function (xhr) {
                    //sacar el cerrar con el ESC al modal
                    //showLoadingModal();
                },
                success: function (data) {
                    //hideLoadingModal();
                    $("#div-resultados").html(data);
                    updateDatatable();
                },
                error: function (e) {
                    //hideLoadingModal();
                }
            });
        }

        _TIPPYINSTANCES = null;
        function updateDatatable() {
            table = $('#lista-actividades').dataTable({
                //responsive: true,
                responsive: agregarResponsiveDatatable("1-3"),
                //scrollX: true,
                fixedHeader: true,
                //"pagingType": "full_numbers_no_ellipses",
                iDisplayLength: 50,
                aaSorting: [
                    [0, "desc"]
                ],
                "drawCallback": function (settings) {
                    if (_TIPPYINSTANCES != null) {
                        for (let instance of _TIPPYINSTANCES) {
                            instance.destroy();
                        }
                    }
                    _TIPPYINSTANCES = tippy('.nodosNoVisibles', {
                        maxWidth: 800,
                        interactive: true,
                    });
                },
                dom: agregarDomDatatable(),
                "lengthMenu": [[10, 25, 50, 100, 300], [10, 25, 50, 100, 300]],
                buttons: [
                    { extend: 'colvis', className: 'md-btn md-btn-small', text: 'Visibilidad' },
                    { extend: 'csv', title: 'Usuarios', className: 'md-btn md-btn-small' },
                    { extend: 'pdf', title: 'Usuarios', className: 'md-btn md-btn-small', orientation: 'landscape', pageSize: 'LEGAL', exportOptions: { columns: ':not(".notExport")' } },
                    { extend: 'print', className: 'md-btn md-btn-small', text: 'Imprimir' }
                ],
                //buttons: agregarBtns(),
                language: agregarLenguajeDatatable(),
            });
        }

        @*function initTablaPaginado()
        {

            if ($("#filterEstructuras").val() == 0) {
                return true;
            }
            dt = $('#lista-roles').dataTable({
                    "scrollX": true,
                    "processing": true, // for show progress bar
                    "bProcessing": true,
                    "serverSide": true, // for process server side
                    "aaSorting": [[0, "asc"]],
                    "filter": true, // this is for enable filter (search box)
                    "orderMulti": false, // for disable multiple column at once
                    "iDisplayLength": 50,
                    "ajax": {
                        "url": "@Url.Action("UsuariosPorRolPaginado", "Rol")",
                        "type": "POST",
                        "data": {
                            rol: $("#roles").val(),
                            est: $("#filterEstructuras").val()
                        },
                        "datatype": "json",
                        "beforeSend": function (xhr) {
                        },
                        "dataSrc": function (json) {
                            return json.data;
                        }
                    },
                aaSorting: [[0, "desc"]],
                aoColumnDefs: [
                    { bSortable: false, aTargets: [-1] }
                ],
                "columns": [
                    { "data": "NombreUsuario", "name": "NombreUsuario" },
                    { "data": "Rol", "name": "Rol" },
                    {
                        "data": function (data) {
                            if (data.ListaNodo.length > 3 ) {
                                return `<span class="uk-badge uk-badge-success uk-badge-notification">${data.ListaNodo[0]}</span>
                                        <span class="uk-badge uk-badge-success uk-badge-notification">${data.ListaNodo[1]}</span>
                                        <span class="uk-badge uk-badge-success uk-badge-notification">${data.ListaNodo[2]}</span>
                                        <span class="uk-badge uk-badge-success uk-badge-notification">${data.ListaNodo.length - 3} +</span>`
                            } else {
                                return `<span class="uk-badge uk-badge-success uk-badge-notification">${data.ListaNodo}</span>`
                            }
                        }, "name": "Nodos"
                    }
                ],
                //"lengthMenu": [[10, 25, 50, 100, 300], [10, 25, 50, 100, 300]],
                buttons: [
                    { extend: 'copy', className: 'md-btn md-btn-small', text: 'Copiar' },
                    { extend: 'csv', title: 'Cuentas', className: 'md-btn md-btn-small' },
                    { extend: 'pdf', title: 'Cuentas', className: 'md-btn md-btn-small', orientation: 'vertical' },
                    { extend: 'print', className: 'md-btn md-btn-small', text: 'Imprimir' }
                ],
                //language: agregarLenguajeDatatable(),
            });

            $('#lista-roles_filter input').unbind();
            $('#lista-roles_filter input').bind('keyup', function (e) {
                if (e.keyCode == 13) {
                    dt.fnFilter(this.value);
                }
            });

        }*@


        </script>

    }
